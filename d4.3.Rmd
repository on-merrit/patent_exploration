---
output: word_document
---

```{r, setup, echo=FALSE, message = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  fig.path = "figure/",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
library(tidyverse)
library(bigrquery)
library(jsonlite)
library(DBI)
library(cowplot)
```

### NPL coverage

```{r}
con <- DBI::dbConnect(
  bigrquery::bigquery(),
  project = "api-project-764811344545"
)
```

```{r}
cpc_by_year <- readr::read_file("sql/cpc_by_year.sql")
cpc_by_year_df <- DBI::dbGetQuery(con, cpc_by_year)

patent_by_year <- cpc_by_year_df %>%
  group_by(pub_year) %>%
  summarise(all = sum(f0_))
  patent_by_year
```

```{r}
cpc_by_year_npl <- readr::read_file("sql/cpc_by_year_npl.sql")
cpc_by_year_npl_df <- DBI::dbGetQuery(con, cpc_by_year_npl)

npl_by_year <- cpc_by_year_npl_df %>%
  group_by(pub_year) %>%
  summarise(npl = sum(f0_))
npl_by_year
```

```{r, npl_plot}
npl_plot_df <- inner_join(npl_by_year, patent_by_year, by = "pub_year") %>%
  mutate(npl_lack = all - npl) %>%
  select(-all) %>%
  pivot_longer(!pub_year)
ggplot(npl_plot_df, aes(as.character(pub_year), value, fill = name, group = name)) +
  geom_area(position = position_stack(reverse = T)) +
   scale_fill_manual(
      values = c(npl_lack = "#cccccca0", npl = "#56b4e9"),
      name = "Cites non-patent-literature",
      labels = c("FALSE", "TRUE")
    ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
  limit = c(0, 3000000), labels = scales::label_number()) +
  cowplot::theme_minimal_hgrid() +
  labs(x = "Publication year", y = "Patent family") +
  theme(legend.position = "top",
          legend.justification = "right")
```

Total number of patents in sample:

`r sum(patent_by_year$all)`

Total number of patents citing at least one NPL

`r sum(npl_by_year$npl)`

Share 

`r sum(npl_by_year$npl) / sum(patent_by_year$all)`

## by subject

```{r}
cpc_patent_by_year <- cpc_by_year_df %>%
  group_by(cpc) %>%
  summarise(all = sum(f0_))

cpc_npl_by_year <- cpc_by_year_npl_df %>%
  group_by(cpc) %>%
  summarise(npl = sum(f0_))

cpc <- tibble::tribble(

~code, ~section,
"A", "Human necessities",
"B","Performing operations; transporting",
"C","Chemistry; metallurgy",
"D","Textiles; paper",
"E","Fixed constructions",
"F", "Mechanical engineering; lighting; heating; weapons; blasting engines or pumps",
"G","Physics",
"H","Electricity",
"Y","General"
)
cpc_df <-inner_join(cpc_patent_by_year, cpc_npl_by_year, by = "cpc") %>%
  inner_join(cpc, by = c("cpc" = "code")) %>%
  mutate(cpc = paste(cpc, section, sep = " - ")) %>%
  select(-section) %>%
  mutate(prop = round(npl / all * 100, 2))
knitr::kable(cpc_df, format.args = list(big.mark = ','))
```

## by country

```{r}
country_per_year <- readr::read_file("sql/country.sql")
country_per_year_df <- DBI::dbGetQuery(con, country_per_year)

country_npl_per_year <- readr::read_file("sql/country_npl.sql")
country_npl_per_year_df <- DBI::dbGetQuery(con, country_npl_per_year)

country_df <- inner_join(country_per_year_df, country_npl_per_year_df, by = "country_code") %>%
  mutate(country = countrycode::countrycode(country_code, origin = "iso2c", destination = 'country.name'))

top_10 <- country_df %>%
  top_n(10, patent_families) %>%
  pull(country_code)
country_df <- country_df %>%
  mutate(country_fac = ifelse(country_code %in% top_10, country, "Other")) %>%
  mutate(country_fac = ifelse(is.na(country_fac), "No Info", country_fac)) %>%
  mutate(country_fac = fct_inorder(country_fac)) %>%
  group_by(country_fac) %>%
  summarise(patent_families_with_npl = sum(patent_families_with_npl, na.rm = TRUE),
    patent_families = sum(patent_families)) %>%
    mutate(prop = round(patent_families_with_npl / patent_families * 100, 2))

country_df %>%
  select(Country = country_fac, `Patent families` = patent_families, `with NPL` = patent_families_with_npl, `in%` = prop) %>%
  knitr::kable()
```

### Number of NPLs per patent family

by inventor's country

```{r dimi_country}
npl_per_country <- readr::read_file("sql/npl_perc_per_country.sql")
npl_per_country_df <- DBI::dbGetQuery(con, npl_per_country)

npl_country_perc_df <- npl_per_country_df %>%
  mutate(country = countrycode::countrycode(country_code, origin = "iso2c", destination = 'country.name')) %>%
  mutate(country_fac = ifelse(country_code %in% top_10, country, "Other")) %>%
  mutate(country_fac = ifelse(is.na(country_fac), "No Info", country_fac)) %>%
  filter(country_code %in% top_10) %>%
  mutate(country_code = factor(country_code, levels = top_10)) %>%
  arrange(country_code = factor(country_code)) %>%
  mutate(country_fac = factor(country_fac, levels = country_fac)) %>%
  filter(!is.na(country))
library(ggeconodist)
a_plot <- npl_country_perc_df %>%
  ggplot() +
  geom_econodist(aes(x = reorder(country_fac, desc(country_fac)), ymin = p10, median = p50, ymax = p90),
         stat = "identity", show.legend = TRUE) +
  scale_y_continuous(position = "right", limits = c(0,max(npl_country_perc_df$p90)))  +  
  coord_flip() +
  labs(
    x = NULL, y = NULL
   # title = "What is the uptake of hybrid open access among Elsevier journals?",
  #  subtitle = "Proportion of immediate open access articles published in subscription-based journals\nJan 2015 to July 2019",
   # caption = "Data source: Elsevier B.V. / Crossref"
  ) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.ticks = element_blank()) +
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.border = element_blank())

grid.newpage()
left_align(a_plot, c("subtitle", "title", "caption")) %>% 
  add_econodist_legend(econodist_legend_grob(family = "sans"), below = "subtitle") %>% 
  grid.draw()
```
