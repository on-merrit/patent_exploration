---
output: word_document
---

```{r, setup, echo=FALSE, message = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  fig.path = "figure/",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
library(tidyverse)
library(bigrquery)
library(DBI)
```

### NPL coverage

```{r}
con <- DBI::dbConnect(
  bigrquery::bigquery(),
  project = "api-project-764811344545"
)
```

```{r}
cpc_by_year <- readr::read_file("sql/cpc_by_year.sql")
cpc_by_year_df <- DBI::dbGetQuery(con, cpc_by_year)

patent_by_year <- cpc_by_year_df %>%
  group_by(pub_year) %>%
  summarise(all = sum(f0_))
```

```{r}
cpc_by_year_npl <- readr::read_file("sql/cpc_by_year_npl.sql")
cpc_by_year_npl_df <- DBI::dbGetQuery(con, cpc_by_year_npl)

npl_by_year <- cpc_by_year_npl_df %>%
  group_by(pub_year) %>%
  summarise(npl = sum(f0_))
```

```{r, npl_plot}
npl_plot_df <- inner_join(npl_by_year, patent_by_year, by = "pub_year") %>%
  mutate(npl_lack = all - npl) %>%
  select(-all) %>%
  pivot_longer(!pub_year) %>%
  filter(pub_year < 2020)
ggplot(npl_plot_df, aes(as.character(pub_year), value, fill = name, group = name)) +
  geom_area(position = position_stack(reverse = T)) +
   scale_fill_manual(
      values = c(npl_lack = "#cccccca0", npl = "#56b4e9"),
      name = "Patents with citations to non-patent-literature",
      labels = c("FALSE", "TRUE")
    ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
  limit = c(0, 3000000), labels = scales::label_number()) +
  cowplot::theme_minimal_hgrid() +
  labs(x = "Publication Year", y = "Patents") +
  theme(legend.position = "top",
          legend.justification = "right")
```

Total number of patents in sample:

`r sum(patent_by_year$all)`

Total number of patents citing at least one NPL

`r sum(npl_by_year$npl)`

Share 

`r sum(npl_by_year$npl) / sum(patent_by_year$all)`

## by subject

```{r}
cpc_patent_by_year <- cpc_by_year_df %>%
  filter(pub_year < 2020) %>%
  group_by(cpc) %>%
  summarise(all = sum(f0_))

cpc_npl_by_year <- cpc_by_year_npl_df %>%
  filter(pub_year < 2020) %>%
  group_by(cpc) %>%
  summarise(npl = sum(f0_))

cpc <- tibble::tribble(

~code, ~section,
"A", "Human necessities",
"B","Performing operations; transporting",
"C","Chemistry; metallurgy",
"D","Textiles; paper",
"E","Fixed constructions",
"F", "Mechanical engineering; lighting; heating; weapons; blasting engines or pumps",
"G","Physics",
"H","Electricity",
"Y","General"
)
cpc_df <-inner_join(cpc_patent_by_year, cpc_npl_by_year, by = "cpc") %>%
  inner_join(cpc, by = c("cpc" = "code")) %>%
  mutate(cpc = paste(cpc, section, sep = " - ")) %>%
  select(-section) %>%
  mutate(prop = round(npl / all * 100, 2))
knitr::kable(cpc_df, format.args = list(big.mark = ','))
```
